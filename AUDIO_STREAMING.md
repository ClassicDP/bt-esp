# Модуль потоковой передачи аудио с микрофона

Этот модуль позволяет передавать аудиоданные с микрофона Bluetooth-гарнитуры на внешний сервер для воспроизведения в реальном времени.

## Компоненты системы

### 1. ESP32 (клиент)
- **audio_streaming.h/.c** - основной модуль потоковой передачи
- Новые команды консоли для управления потоком
- Автоматическая отправка аудиоданных при получении с микрофона

### 2. Python сервер (audio_server.py)
- Принимает TCP-соединения от ESP32
- Воспроизводит полученные аудиоданные через динамики компьютера
- Поддерживает различные форматы аудио (8kHz/16kHz, моно/стерео)

## Быстрый старт

### Настройка сервера
```bash
# Установка зависимостей
pip install -r requirements.txt

# Запуск сервера (по умолчанию порт 8888)
python3 audio_server.py

# Или с указанием хоста и порта
python3 audio_server.py --host 0.0.0.0 --port 8888
```

### Настройка ESP32

1. **Подключение Bluetooth-гарнитуры:**
   ```
   con XX:XX:XX:XX:XX:XX  # MAC адрес гарнитуры
   ```

2. **Инициализация потоковой передачи:**
   ```
   stream_init 192.168.1.100 8888  # IP сервера и порт
   stream_start                     # Запуск потока
   ```

3. **Активация микрофона:**
   ```
   miclevel     # Запуск мониторинга и активация микрофона
   # или
   call_start   # Симуляция входящего вызова
   ```

## Команды управления

### Потоковая передача
- `stream_init <server_ip> <port>` - инициализация соединения с сервером
- `stream_start` - запуск потоковой передачи
- `stream_stop` - остановка потока
- `stream_status` - проверка статуса соединения

### Управление аудио
- `miclevel` - активация микрофона и мониторинг уровня
- `call_start` - симуляция входящего вызова
- `cona` - подключение аудиоканала
- `disa` - отключение аудиоканала

### Диагностика
- `audiostatus` - проверка состояния аудиосоединения
- `stream_status` - статус потоковой передачи

## Принцип работы

1. **Инициализация:** ESP32 создает TCP-соединение с сервером
2. **Заголовок:** Отправляется информация о формате аудио (частота, каналы, бит/сэмпл)
3. **Поток данных:** Аудиоданные с микрофона передаются в реальном времени
4. **Воспроизведение:** Сервер немедленно воспроизводит полученные данные

## Поддерживаемые форматы

- **CVSD кодек:** 8 kHz, моно, 16-бит
- **mSBC кодек:** 16 kHz, моно, 16-бит
- Автоматическое определение кодека от Bluetooth-устройства

## Диагностика проблем

### ESP32 не отправляет данные
1. Проверьте подключение аудио: `audiostatus`
2. Убедитесь, что микрофон активен: `miclevel`
3. Проверьте соединение с сервером: `stream_status`

### Сервер не получает данные
1. Проверьте сетевое соединение
2. Убедитесь, что порт не заблокирован файрволом
3. Проверьте логи ESP32 на ошибки соединения

### Нет звука на сервере
1. Проверьте настройки звука системы
2. Убедитесь, что PyAudio установлен корректно
3. Попробуйте разные аудиоустройства

## Примеры использования

### Полный цикл работы:
```bash
# На сервере
python3 audio_server.py

# На ESP32 (через UART консоль)
con B0:F1:A3:01:2D:2E    # Подключение гарнитуры
stream_init 192.168.1.100 8888  # Настройка сервера
stream_start              # Запуск потока
miclevel                 # Активация микрофона
# Говорите в микрофон - звук будет воспроизводиться на сервере
stream_stop              # Остановка потока
```

### Быстрый тест:
```bash
# ESP32
call_start               # Симуляция вызова (автоответ через 2 сек)
# Микрофон активируется автоматически
```

## Технические детали

- **Протокол:** TCP сокеты
- **Буферизация:** Минимальная задержка (~50-100мс)
- **Сжатие:** Без сжатия (raw PCM)
- **Многопоточность:** Отдельные потоки для приема и воспроизведения
- **Обработка ошибок:** Автоматическое переподключение при разрыве связи
